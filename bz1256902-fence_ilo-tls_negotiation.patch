From 60d5f2bfda2e5f39b698c5a465fbe9262c56e758 Mon Sep 17 00:00:00 2001
From: Marek 'marx' Grac <mgrac@redhat.com>
Date: Wed, 26 Aug 2015 16:24:30 +0200
Subject: [PATCH 3/6] fence_ilo: If gnutls can not open connection than
 --tls1.0 is tried in second attempt

Resolves: rhbz#1256902
---
 fence/agents/ilo/fence_ilo.py | 17 +++++++++++++++++
 1 file changed, 17 insertions(+)

diff --git a/fence/agents/ilo/fence_ilo.py b/fence/agents/ilo/fence_ilo.py
index b9be62a..36979bf 100644
--- a/fence/agents/ilo/fence_ilo.py
+++ b/fence/agents/ilo/fence_ilo.py
@@ -95,6 +95,23 @@ the iLO card through an XML stream."
 	try:
 		conn.send("<?xml version=\"1.0\"?>\r\n")
 		conn.log_expect(["</RIBCL>", "<END_RIBCL/>"], int(options["--login-timeout"]))
+	except pexpect.TIMEOUT:
+		fail(EC_LOGIN_DENIED)
+	except pexpect.EOF:
+		if "--tls1.0" in options:
+			fail(EC_LOGIN_DENIED)
+		options["--tls1.0"] = "1"
+		conn.close()
+		conn = fence_login(options)
+		try:
+			conn.send("<?xml version=\"1.0\"?>\r\n")
+			conn.log_expect(["</RIBCL>", "<END_RIBCL/>"], int(options["--login-timeout"]))
+		except pexpect.TIMEOUT:
+			fail(EC_LOGIN_DENIED)
+		except pexpect.EOF:
+			fail(EC_LOGIN_DENIED)
+
+	try:
 		version = re.compile("<RIBCL VERSION=\"(.*?)\"", re.IGNORECASE).search(conn.before).group(1)
 		if not options.has_key("--ribcl-version"):
 			options["--ribcl-version"] = float(version)
-- 
1.9.3

